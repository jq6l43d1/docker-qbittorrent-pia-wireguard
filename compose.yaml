name: pia-qbittorrent
services:
  pia-wireguard:
    image: thrnz/docker-wireguard-pia
    container_name: pia-wireguard-${INSTANCE_NAME}
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - pia-shared:/pia-shared
    environment:
      # PIA Credentials (set in .env file)
      - USER=${PIA_USER}
      - PASS=${PIA_PASS}

      # Server location (set in .env file)
      - LOC=${PIA_LOCATION}

      # Port forwarding
      - PORT_FORWARDING=1
      - PORT_FILE=/pia-shared/port.dat
      - PORT_PERSIST=1

      # Network settings
      - LOCAL_NETWORK=192.168.0.0/16,172.16.0.0/12
      - KEEPALIVE=25

      # Security
      - FIREWALL=1
      - EXIT_ON_FATAL=0

      # Timezone
      - TZ=${TZ:-Etc/UTC}
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    ports:
      # qBittorrent WebUI (configurable port for multi-instance support)
      - "${WEBUI_PORT:-8080}:${WEBUI_PORT:-8080}"
      # Firefox browser (optional - only used when firefox profile is enabled)
      - "${FIREFOX_PORT:-3000}:3000"
      - "${FIREFOX_PORT_HTTPS:-3001}:3001"
      # Note: BitTorrent peer port does not need Docker port mapping
      # Peers connect through the VPN tunnel, bypassing Docker's port mapping
      # qBittorrent is auto-configured to listen on PIA's forwarded port
    healthcheck:
      test: ["CMD", "sh", "-c", "ping -c 1 -W 3 1.1.1.1 > /dev/null 2>&1"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 45s
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent-${INSTANCE_NAME}
    network_mode: "container:pia-wireguard-${INSTANCE_NAME}"
    depends_on:
      pia-wireguard:
        condition: service_healthy
    environment:
      # User/Group configuration
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}

      # WebUI configuration
      - WEBUI_PORT=${WEBUI_PORT:-8080}
    volumes:
      # qBittorrent config (instance-specific Docker volume)
      - qbittorrent-config:/config
      # Downloads directory (shared with Sonarr for hardlinks)
      - /data:/data
      # Access to PIA shared data (for reading forwarded port)
      - pia-shared:/pia-shared:ro
      # Custom init scripts for auto-configuration
      - ./custom-init:/custom-cont-init.d:ro
      # Port monitoring service (automatically updates port when PIA changes it)
      - ./custom-services.d:/custom-services.d:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${WEBUI_PORT:-8080}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  firefox:
    image: lscr.io/linuxserver/firefox:latest
    container_name: firefox-${INSTANCE_NAME}
    profiles:
      - firefox
    network_mode: "container:pia-wireguard-${INSTANCE_NAME}"
    depends_on:
      pia-wireguard:
        condition: service_healthy
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Etc/UTC}
    volumes:
      - firefox-config:/config
    shm_size: "1gb"
    restart: unless-stopped

volumes:
  pia-shared:
    name: pia-shared-${INSTANCE_NAME}
  qbittorrent-config:
    name: qbittorrent-config-${INSTANCE_NAME}
  firefox-config:
    name: firefox-config-${INSTANCE_NAME}
